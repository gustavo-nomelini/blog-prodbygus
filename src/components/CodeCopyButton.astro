---
// CodeCopyButton.astro - Componente para adicionar botões de cópia a todos os blocos de código
---

<!-- JavaScript não-bloqueante para adicionar botões de cópia -->
<script is:inline>
  // Função para adicionar botões de cópia
  function addCopyButtonsToCodeBlocks() {
    console.log('Adicionando botões de cópia aos blocos de código...');
    const codeBlocks = document.querySelectorAll('pre');
    console.log(`Encontrados ${codeBlocks.length} blocos de código`);
    
    codeBlocks.forEach((pre, index) => {
      // Remover botões existentes para evitar duplicação
      pre.querySelectorAll('.copy-button').forEach(btn => btn.remove());
      
      // Garantir que pré tenha position relative
      pre.style.position = 'relative';
      
      // Criar um novo botão
      const copyButton = document.createElement('button');
      copyButton.className = 'copy-button';
      copyButton.setAttribute('type', 'button');
      copyButton.setAttribute('aria-label', 'Copiar código');
      copyButton.setAttribute('title', 'Copiar código');
      copyButton.innerHTML = '<span class="copy-text">Copiar</span>';
      
      // Adicionar o botão ao bloco de código
      pre.appendChild(copyButton);
      
      // Adicionar evento de clique
      copyButton.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        if (!code) return;
        
        try {
          await navigator.clipboard.writeText(code.textContent || '');
          copyButton.classList.add('success');
          copyButton.querySelector('.copy-text').textContent = 'Copiado!';
          
          setTimeout(() => {
            copyButton.classList.remove('success');
            copyButton.querySelector('.copy-text').textContent = 'Copiar';
          }, 2000);
        } catch (err) {
          console.error('Erro ao copiar:', err);
          copyButton.classList.add('error');
          copyButton.querySelector('.copy-text').textContent = 'Erro!';
          
          setTimeout(() => {
            copyButton.classList.remove('error');
            copyButton.querySelector('.copy-text').textContent = 'Copiar';
          }, 2000);
        }
      });
    });
  }
  
  // Executar assim que o DOM estiver pronto
  document.addEventListener('DOMContentLoaded', addCopyButtonsToCodeBlocks);
  
  // Também executar quando a página estiver totalmente carregada
  window.addEventListener('load', addCopyButtonsToCodeBlocks);
  
  // Executar periodicamente para garantir que todos os blocos de código tenham botões
  setInterval(addCopyButtonsToCodeBlocks, 2000);
</script>

<style is:global>
  /* Estilos para o botão de cópia */
  .copy-button {
    position: absolute !important;
    top: 8px !important;
    right: 8px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 6px 12px !important;
    background-color: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    border: none !important;
    border-radius: 4px !important;
    font-family: system-ui, -apple-system, sans-serif !important;
    font-size: 12px !important;
    font-weight: 500 !important;
    cursor: pointer !important;
    z-index: 9999 !important;
    opacity: 1 !important;
    transition: all 0.2s ease !important;
    visibility: visible !important;
    pointer-events: auto !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
  }
  
  .copy-button:hover {
    background-color: rgba(255, 255, 255, 0.3) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
  }
  
  .copy-button:active {
    transform: translateY(0) !important;
  }
  
  .copy-button.success {
    background-color: rgba(72, 187, 120, 0.8) !important;
  }
  
  .copy-button.error {
    background-color: rgba(229, 62, 62, 0.8) !important;
  }
  
  /* Espaço para o botão de cópia */
  pre {
    padding-top: 38px !important;
    position: relative !important;
    overflow: visible !important;
  }
  
  /* Garantir que o botão seja sempre visível */
  [data-rehype-pretty-code-fragment],
  .code-block-wrapper,
  .prose pre {
    position: relative !important;
    overflow: visible !important;
  }
  
  .copy-text {
    color: white !important;
    font-weight: bold !important;
  }
</style>

<!-- Script para garantir que os botões sejam adicionados mesmo após mudanças no DOM -->
<script>
  // Observar mudanças no DOM para adicionar botões a novos blocos de código
  document.addEventListener('DOMContentLoaded', () => {
    // Observador de mutações para monitorar novos blocos de código
    const observer = new MutationObserver((mutations) => {
      let codeBlocksAdded = false;
      
      mutations.forEach(mutation => {
        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
          for (const node of mutation.addedNodes) {
            if (node.nodeType === 1) { // Element node
              if (node.tagName === 'PRE' || node.querySelector('pre')) {
                codeBlocksAdded = true;
                break;
              }
            }
          }
        }
      });
      
      if (codeBlocksAdded) {
        // Adicionar botões com um pequeno atraso para garantir que o DOM está estável
        setTimeout(() => {
          addCopyButtonsToCodeBlocks();
        }, 100);
      }
    });
    
    // Iniciar observação do DOM
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  });
</script> 